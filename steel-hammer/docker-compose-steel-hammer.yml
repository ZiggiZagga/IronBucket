services:

  steel-hammer-postgres:

    networks:
      - steel-hammer-network

    hostname: steel-hammer-postgres
    container_name: steel-hammer-postgres

    build:
      context: . 
      dockerfile: ./postgres/DockerfilePostgres
    
    environment:
      - "POSTGRES_PASSWORD=postgres_admin_pw"
    volumes:
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql

    restart: always


  steel-hammer-keycloak:
    networks:
      - steel-hammer-network

    restart: always
    
    hostname: steel-hammer-keycloak
    container_name: steel-hammer-keycloak

    build:
      context: . 
      dockerfile: ./keycloak/DockerfileKeycloak
    
    #TODO security first
    #entrypoint: [ "/opt/keycloak/keycloak/bin/kc.sh", "start","--hostname", "steel-hammer-keycloak",  "--https-port=7082" ]
    entrypoint: [ "/opt/keycloak/keycloak/bin/kc.sh", "start-dev", "--import-realm",  "--http-port=7081" ]
    
    volumes:      
       - ./keycloak/dev-realm.json:/opt/keycloak/keycloak/data/import/dev-realm.json
      
    environment:
      #- "KC_HTTPS_KEY_STORE_FILE=/opt/keycloak/certs/keycloak.jks"
      #- "KC_HTTPS_KEY_STORE_PASSWORD=KC_HTTPS_KEY_STORE_PASSWORD"
      - "KC_BOOTSTRAP_ADMIN_USERNAME=admin"
      - "KC_BOOTSTRAP_ADMIN_PASSWORD=admin"
      - "KC_DB=postgres"
      - "KC_DB_USERNAME=keycloak_db_user"
      - "KC_DB_PASSWORD=keycloak_db_pass"
      - "KC_DB_URL=jdbc:postgresql://steel-hammer-postgres:5432/keycloak"

    depends_on:
      - steel-hammer-postgres

  steel-hammer-buzzle-vane:
    networks:
      - steel-hammer-network

    hostname: steel-hammer-buzzle-vane
    container_name: steel-hammer-buzzle-vane

    build:
      context: ../temp/Buzzle-Vane
      dockerfile: Dockerfile

    depends_on:
      - steel-hammer-keycloak
      - steel-hammer-postgres

    environment:
      - "SPRING_PROFILES_ACTIVE=docker"
      - "SPRING_APPLICATION_NAME=buzzle-vane"
      - "EUREKA_SERVER_ENABLE_SELF_PRESERVATION=false"
      - "MANAGEMENT_OTLP_TRACING_ENDPOINT=http://localhost:4317"
      - "MANAGEMENT_METRICS_TAGS_ENVIRONMENT=docker"
      - "OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 3

    restart: "always"

  steel-hammer-sentinel-gear:
    networks:
      - steel-hammer-network

    hostname: steel-hammer-sentinel-gear
    container_name: steel-hammer-sentinel-gear

    build:
      context: ../temp/Sentinel-Gear
      dockerfile: Dockerfile

    ports:
      - "8080:8080"
      - "8081:8081"

    depends_on:
      - steel-hammer-keycloak
      - steel-hammer-postgres
      - steel-hammer-buzzle-vane

    environment:
      - "SPRING_PROFILES_ACTIVE=docker"
      - "POSTGRES_PASSWORD=postgres_admin_pw"
      - "SPRING_APPLICATION_NAME=sentinel-gear"
      - "EUREKA_URI=http://steel-hammer-buzzle-vane:8083/eureka"
      - "MANAGEMENT_OTLP_TRACING_ENDPOINT=http://localhost:4317"
      - "MANAGEMENT_METRICS_TAGS_ENVIRONMENT=docker"
      - "OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 3

    restart: "always"

  steel-hammer-claimspindel:
    networks:
      - steel-hammer-network

    hostname: steel-hammer-claimspindel
    container_name: steel-hammer-claimspindel

    build:
      context: ../temp/Claimspindel
      dockerfile: Dockerfile

    depends_on:
      - steel-hammer-keycloak
      - steel-hammer-postgres
      - steel-hammer-buzzle-vane
      - steel-hammer-sentinel-gear

    environment:
      - "SPRING_PROFILES_ACTIVE=docker"
      - "POSTGRES_PASSWORD=postgres_admin_pw"
      - "SPRING_APPLICATION_NAME=claimspindel"
      - "EUREKA_URI=http://steel-hammer-buzzle-vane:8083/eureka"
      - "MANAGEMENT_OTLP_TRACING_ENDPOINT=http://localhost:4317"
      - "MANAGEMENT_METRICS_TAGS_ENVIRONMENT=docker"
      - "OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 3

    restart: "always"

  steel-hammer-brazz-nossel:
    networks:
      - steel-hammer-network

    hostname: steel-hammer-brazz-nossel
    container_name: steel-hammer-brazz-nossel

    build:
      context: ../temp/Brazz-Nossel
      dockerfile: Dockerfile

    depends_on:
      - steel-hammer-keycloak
      - steel-hammer-buzzle-vane
      - steel-hammer-postgres
      - steel-hammer-claimspindel
      - steel-hammer-minio

    environment:
      - "SPRING_PROFILES_ACTIVE=docker"
      - "POSTGRES_PASSWORD=postgres_admin_pw"
      - "MINIO_ACCESS_KEY=minioadmin"
      - "MINIO_SECRET_KEY=minioadmin"
      - "SPRING_APPLICATION_NAME=brazz-nossel"
      - "EUREKA_URI=http://steel-hammer-buzzle-vane:8083/eureka"
      - "MANAGEMENT_OTLP_TRACING_ENDPOINT=http://localhost:4317"
      - "MANAGEMENT_METRICS_TAGS_ENVIRONMENT=docker"
      - "OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 3

    restart: "always"

  steel-hammer-minio:
    networks:
      - steel-hammer-network

    hostname: steel-hammer-minio
    container_name: steel-hammer-minio

    restart: always

    build:
      context: ./minio
      dockerfile: DockerfileMinio

    command: /opt/minio/minio server /opt/minio/data --console-address=":9001"

    environment:
      - "MINIO_BROWSER=on"
      - "MINIO_ROOT_USER=minioadmin"
      - "MINIO_ROOT_PASSWORD=minioadmin"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 3

  steel-hammer-test:
    networks:
      - steel-hammer-network

    hostname: steel-hammer-test
    container_name: steel-hammer-test

    build:
      context: .
      dockerfile: ./DockerfileTestRunner

    volumes:
      - ./tests:/tests
      - /tmp/ironbucket-test:/tmp/ironbucket-test
      - ./test-scripts:/scripts:ro
      - ../temp:/workspaces/IronBucket/temp:ro
      - ../.git:/ironbucket/.git:ro

    depends_on:
      - steel-hammer-keycloak
      - steel-hammer-postgres
      - steel-hammer-sentinel-gear
      - steel-hammer-claimspindel
      - steel-hammer-brazz-nossel
      - steel-hammer-buzzle-vane

    environment:
      - "KEYCLOAK_URL=http://steel-hammer-keycloak:7081"
      - "MINIO_URL=http://steel-hammer-minio:9000"
      - "POSTGRES_HOST=steel-hammer-postgres"
      - "SENTINEL_GEAR_URL=http://steel-hammer-sentinel-gear:8080"
      - "CLAIMSPINDEL_URL=http://steel-hammer-claimspindel:8081"
      - "BRAZZ_NOSSEL_URL=http://steel-hammer-brazz-nossel:8082"
      - "BUZZLE_VANE_URL=http://steel-hammer-buzzle-vane:8083"

    # Test will run automatically when container starts
    # Runs all Maven tests from mounted /workspaces/IronBucket/temp directory
    entrypoint: ["/bin/sh", "-c", "sleep 60 && /scripts/run-containerized-maven-tests.sh"]

    restart: "no"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  steel-hammer-network:
    driver: bridge
