name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Mondays at 00:00 UTC
    - cron: '0 0 * * 1'

permissions:
  contents: read
  security-events: write

jobs:
  dependency-check:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Java 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
      
      - name: Run OWASP Dependency Check
        run: |
          # Install dependency-check-maven plugin and run
          for module in Sentinel-Gear Claimspindel Brazz-Nossel Buzzle-Vane; do
            echo "Scanning $module for vulnerabilities..."
            cd temp/$module
            mvn org.owasp:dependency-check-maven:check \
              -DfailBuildOnCVSS=7 \
              -DsuppressionFile=../../.github/dependency-check-suppressions.xml || true
            cd ../..
          done
      
      - name: Upload dependency check reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: |
            **/target/dependency-check-report.html
          retention-days: 30

  spotbugs:
    name: SpotBugs Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Java 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
      
      - name: Build Pactum-Scroll
        run: |
          cd temp/Pactum-Scroll
          mvn clean install -DskipTests -B || echo "Pactum-Scroll build skipped"
      
      - name: Run SpotBugs
        run: |
          for module in Sentinel-Gear Claimspindel Brazz-Nossel Buzzle-Vane; do
            echo "Running SpotBugs on $module..."
            cd temp/$module
            mvn compile spotbugs:check -B || true
            cd ../..
          done
      
      - name: Upload SpotBugs reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-reports
          path: |
            **/target/spotbugsXml.xml
          retention-days: 30

  checkstyle:
    name: Code Style Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Java 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
      
      - name: Run Checkstyle
        run: |
          for module in Sentinel-Gear Claimspindel Brazz-Nossel Buzzle-Vane; do
            echo "Running Checkstyle on $module..."
            cd temp/$module
            mvn checkstyle:check -B || true
            cd ../..
          done
      
      - name: Upload Checkstyle reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-reports
          path: |
            **/target/checkstyle-result.xml
          retention-days: 30

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-check, spotbugs, checkstyle, secret-scan]
    if: always()
    
    steps:
      - name: Generate security summary
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Check | ${{ needs.dependency-check.result == 'success' && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SpotBugs | ${{ needs.spotbugs.result == 'success' && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkstyle | ${{ needs.checkstyle.result == 'success' && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result == 'success' && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
